apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config--boost
data:
  default.conf: |-

    server {
      listen 80;
      server_name {{.Values.publicFqdn}};
      return 301 $scheme://www.{{.Values.publicFqdn}}$request_uri;
    }

    server {
      listen 80;
      server_name {{.Values.publicFqdn2}};
      return 301 $scheme://www.{{.Values.publicFqdn2}}$request_uri;
    }

    server {
      listen 80;
      server_name {{.Values.publicFqdn3}};
      return 301 $scheme://www.{{.Values.publicFqdn3}}$request_uri;
    }

    server {
      listen 80;
      server_name {{.Values.publicFqdn4}};
      return 301 $scheme://www.{{.Values.publicFqdn4}}$request_uri;
    }

    server {
      listen 80 deferred default;
      server_name www.{{.Values.publicFqdn}} www.{{.Values.publicFqdn2}} www.{{.Values.publicFqdn3}} www.{{.Values.publicFqdn4}} ;

      error_log /dev/stdout info;
      access_log /dev/stdout main;

      proxy_set_header        Host            $host;
      proxy_set_header        X-Real-IP       $remote_addr;
      proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header        X-Forwarded-Proto $scheme;
      client_max_body_size    {{.Values.clientMaxBodySize|quote}};
      client_body_buffer_size 128k;
      proxy_connect_timeout   90;
      proxy_send_timeout      90;
      proxy_read_timeout      90;
      proxy_buffers           16 100k;

      proxy_redirect off;

      location /lbcheck {
          return 200 'OK';
          add_header Content-Type text/plain;
      }

      location @django1 {
          proxy_pass http://unix:/run/gunicorn.sock;
          proxy_intercept_errors on;
          recursive_error_pages on;
          error_page 404 = @django2;
      }

      location @django2 {
          if ($uri !~* /$ ) {
              # "basic" redirect, adding a slash:
              # rewrite  ^(.*)$  $1/ redirect;
              #
              # instead, redirect everything to https
              # (since nginx is only seeing http at the pod)
              rewrite  ^(.*)$  https://$host$1/ redirect;
          }
          proxy_pass http://unix:/run/gunicorn.sock;
      }

      location / {
          try_files not_a_file.html @django1;
      }

      location /static {
        alias /code/static_deploy;
        # manage in CDN
        # expires 7d;
      }

      location /media {
        alias /code/media;
        # manage in CDN
        # expires 1d;
      }

      location ~ ^/sgi/stl/(.*)$ { return 301 https://stl.boost.org/$1; }
      location = /more/getting_started/index.html { return 301 /doc/user-guide/getting-started.html; }
      location = /map.html { return 301 /docs/; }
      location = /users/ { return 301 /doc/user-guide/index.html; }
      location = /users/download/ { return 301 /releases/; }
      location = /users/news/ { return 301 /news/; }
      location = /users/history/ { return 301 /releases/; }
      location = /users/license.html { return 301 /doc/user-guide/bsl.html; }
      location = /users/memoriam.html { return 301 /doc/user-guide/in-memoriam-beman-dawes.html; }
      location = /users/memoriam/beman_dawes.html { return 301 /doc/user-guide/in-memoriam-beman-dawes.html; }
      location = /users/bibliography.html { return 301 /doc/user-guide/resources.html; }
      location = /users/faq.html { return 301 /doc/user-guide/faq.html; }
      location = /users/proposal.pdf { return 301 /doc/user-guide/boost-history.html; }
      location ~ ^/users/history/version_(\d+)_(\d+)_(\d+)\.html$ { return 301 /releases/$1.$2.$3/; }
      location = /community/groups.html { return 301 /community/; }
      location = /community/policy.html { return 301 /doc/user-guide/discussion-policy.html; }
      location = /community/cpp.html { return 301 /doc/user-guide/faq.html#isocommitteemeetings; }
      location = /community/committee.html { return 301 /doc/user-guide/faq.html#isocommitteemeetings; }
      location = /community/generic_programming.html { return 301 /doc/user-guide/generic-programming.html; }
      location = /community/exception_safety.html { return 301 /doc/user-guide/exception-safety.html; }
      location = /community/counted_body.html { return 301 /doc/user-guide/counted-body.html; }
      location = /community/implementation_variations.html { return 301 /doc/user-guide/implementation-variations.html; }
      location = /community/requests.html { return 301 /community/; }
      location = /community/reviews.html { return 301 /review/; }
      location = /community/review_schedule.html { return 301 /review/past/; }
      location = /development/index.html { return 301 /boost-development/; }
      location = /development/submissions.html { return 301 /review/; }
      location = /development/bugs.html { return 301 /doc/user-guide/reporting-issues.html; }
      location = /development/pull_requests.php { return 301 $scheme://$host; }
      location = /development/testing.html { return 301 /doc/contributor-guide/testing/boost-test-matrix.html#_regression_dashboard; }
      location = /development/tests/master/developer/summary.html { return 301 https://regression.boost.io/master/developer/summary.html; }
      location = /development/tests/master/developer/issues.html { return 301 https://regression.boost.io/master/developer/issues.html; }
      location = /development/tests/develop/developer/summary.html { return 301 https://regression.boost.io/develop/developer/summary.html; }
      location = /development/tests/develop/developer/issues.html { return 301 https://regression.boost.io/develop/developer/issues.html; }
      location ~ ^/(development/running_regression_tests.html|doc/regression)$ { return 301 /doc/contributor-guide/testing/regression-tests.html; }
      location = /development/requirements.html { return 301 /doc/contributor-guide/index.html; }
      location = /development/test.html { return 301 /doc/contributor-guide/testing/intro.html; }
      location = /development/header.html { return 301 /doc/contributor-guide/design-guide/headers.html; }
      location = /development/separate_compilation.html { return 301 /doc/contributor-guide/design-guide/separate-compilation.html; }
      location = /development/library_metadata.html { return 301 /doc/contributor-guide/requirements/library-metadata.html; }
      location = /more/generic_exception_safety.html { return 301 /doc/user-guide/exception-safety.html; }
      location = /doc/ { return 301 /libraries/; }
      location = /libs/ { return 301 /libraries/; }
      location = /doc/libs/ { return 301 /libraries/; }
      location = /build/ { return 301 /tools/build/; }
      location = /more/lib_guide.htm { return 301 /doc/contributor-guide/index.html; }

      location /doc/libs/ {
        location ~ ^/doc/libs/(1_31_0|1_32_0|1_33_0)/tools/boostbook$ { return 301 /doc/libs/$1/tools/boostbook/doc/html/index.html; }
        # the following block of locations are from the nginx redirect configuration and 
        #  should be replaced with the newly generated block automatically, see docs/nginx_redirects.md
        # GENERATED - DO NOT MANUALLY EDIT BLOCK, START #
        location = /doc/libs/1.33.0/libs/spirit/example { return 301 https://github.com/boostorg/spirit/tree/boost-1.33.0/example; }
        location = /doc/libs/1.69.0/libs/beast/example/cppcon2018 { return 301 https://github.com/boostorg/beast/tree/boost-1.69.0/example/cppcon2018; }
        location ~ ^/doc/libs/(1.30.0|1.31.0|1.32.0|1.33.0)/libs/python/build/VisualStudio$ { return 301 https://github.com/boostorg/python/tree/boost-$1/build/VisualStudio; }
        location ~ ^/doc/libs/(1.30.0|1.31.0|1.32.0|1.33.0)/libs/python/test$ { return 301 https://github.com/boostorg/python/tree/boost-$1/test; }
        location ~ ^/doc/libs/(1.30.0|1.31.0|1.32.0|1.33.0|1.34.0|1.35.0|1.36.0|1.37.0|1.38.0|1.39.0|1.40.0|1.41.0|1.42.0|1.43.0|1.44.0|1.45.0|1.46.0|1.47.0|1.48.0|1.49.0|1.50.0|1.51.0|1.52.0|1.53.0|1.54.0|1.55.0|1.56.0|1.57.0|1.58.0|1.59.0|1.60.0|1.61.0|1.62.0|1.63.0|1.64.0|1.65.0|1.66.0|1.67.0|1.68.0|1.69.0|1.70.0|1.71.0|1.72.0|1.73.0|1.74.0|1.75.0|1.76.0|1.77.0|1.78.0|1.79.0|1.80.0|1.81.0|1.82.0|1.83.0|1.84.0|1.85.0|1.86.0)/boost/compatibility/cpp_c_headers$ { return 301 https://github.com/boostorg/compatibility/tree/boost-$1/include/boost/compatibility/cpp_c_headers; }
        location ~ ^/doc/libs/(1.31.0|1.32.0|1.33.0)/libs/python/example$ { return 301 https://github.com/boostorg/python/tree/boost-$1/example; }
        location ~ ^/doc/libs/(1.31.0|1.32.0|1.33.0)/tools/build/v2/example/customization$ { return 301 https://github.com/boostorg/build/tree/boost-$1/v2/example/customization; }
        location ~ ^/doc/libs/(1.33.0|1.34.0)/libs/iostreams/build$ { return 301 https://github.com/boostorg/iostreams/tree/boost-$1/build; }
        location ~ ^/doc/libs/(1.35.0|1.36.0|1.37.0|1.38.0|1.39.0|1.40.0|1.41.0|1.42.0|1.43.0)/libs/filesystem/example$ { return 301 https://github.com/boostorg/filesystem/tree/boost-$1/example; }
        location ~ ^/doc/libs/(1.44.0|1.45.0|1.46.0|1.47.0|1.48.0|1.49.0)/libs/filesystem/v3/src$ { return 301 https://github.com/boostorg/filesystem/tree/boost-$1/v3/src; }
        location ~ ^/doc/libs/(1.50.0|1.51.0|1.52.0|1.53.0|1.54.0|1.55.0|1.56.0|1.57.0|1.58.0)/libs/filesystem/doc/src$ { return 301 https://github.com/boostorg/filesystem/tree/boost-$1/doc/src; }
        location ~ ^/doc/libs/([^/]+)/boost/archive/(detail|impl|iterators)$ { return 301 https://github.com/boostorg/serialization/tree/boost-$1/include/boost/archive/$2; }
        location ~ ^/doc/libs/([^/]+)/libs/beast/example$ { return 301 https://github.com/boostorg/beast/tree/boost-$1/example; }
        location ~ ^/doc/libs/([^/]+)/libs/beast/example/websocket/server/chat-multi$ { return 301 https://github.com/boostorg/beast/tree/boost-$1/example/websocket/server/chat-multi; }
        location ~ ^/doc/libs/([^/]+)/libs/bimap/example$ { return 301 https://github.com/boostorg/bimap/tree/boost-$1/example; }
        location ~ ^/doc/libs/([^/]+)/libs/filesystem/src$ { return 301 https://github.com/boostorg/filesystem/tree/boost-$1/src; }
        location ~ ^/doc/libs/([^/]+)/libs/filesystem/v2/(example|src)$ { return 301 https://github.com/boostorg/filesystem/tree/boost-$1/v2/$2; }
        location ~ ^/doc/libs/([^/]+)/libs/regex/test/(captures|concepts|pathology|regress)$ { return 301 https://github.com/boostorg/regex/tree/boost-$1/test/$2; }
        location ~ ^/doc/libs/([^/]+)/libs/serialization/src$ { return 301 https://github.com/boostorg/serialization/tree/boost-$1/src; }
        location ~ ^/doc/libs/([^/]+)/libs/sort/example$ { return 301 https://github.com/boostorg/sort/tree/boost-$1/example; }
        location ~ ^/doc/libs/([^/]+)/libs/spirit/example/qi/mini_xml_samples$ { return 301 https://github.com/boostorg/spirit/tree/boost-$1/example/qi/mini_xml_samples; }
        location ~ ^/doc/libs/([^/]+)/libs/spirit/example/support/utree$ { return 301 https://github.com/boostorg/spirit/tree/boost-$1/example/support/utree; }
        location ~ ^/doc/libs/([^/]+)/libs/spirit/example/x3/rexpr/rexpr_full$ { return 301 https://github.com/boostorg/spirit/tree/boost-$1/example/x3/rexpr/rexpr_full; }
        # GENERATED - DO NOT MANUALLY EDIT BLOCK, END #
      }
    
      include /etc/nginx/mime.types;
    }
